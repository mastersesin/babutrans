-- Misty Peak dungeon....--script numberx402276_g_ScriptId = 402276x402276_g_CopySceneType = FUBEN_PIAOMIAOFENG	-- Copy type, defined in ScriptGlobal.luax402276_g_TickTime		= 1				--The clock time of the callback script (unit: second/time)x402276_g_NoUserTime	= 300			--The time to continue saving after there is no one in the copy (unit: second)x402276_g_Fuben_X			= 124			--Enter copy at position Xx402276_g_Fuben_Z			= 164			-- Enter position Z of copyx402276_g_FuBenTime		= 3*60*60	-- Copy close time....--BOSS table....x402276_g_BOSSList ={	["HaDaBa_NPC"]				= { DataID=9668, Title="", posX=124, posY=86, Dir=0, BaseAI=3, AIScript=0, ScriptID=402283 },	["HaDaBa_BOSS"]				= { DataID=9660, Title="", posX=124, posY=86, Dir=0, BaseAI=27, AIScript=0, ScriptID=402277 },	["SangTuGong_NPC"]		= { DataID=9669, Title="", posX=41, posY=105, Dir=0, BaseAI=3, AIScript=0, ScriptID=402284 },	["SangTuGong_BOSS"]		= { DataID=9661, Title="", posX=41, posY=105, Dir=0, BaseAI=27, AIScript=0, ScriptID=402278 },	["JiangShi_BOSS"]			= { DataID=9662, Title="", posX=0, posY=0, Dir=0, BaseAI=28, AIScript=0, ScriptID=-1 },	["WuLaoDa_NPC"]				= { DataID=9670, Title="VÕn Tiên Chi Thü", posX=117, posY=49, Dir=11, BaseAI=3, AIScript=0, ScriptID=402285 },	["WuLaoDaLoss_NPC"]		= { DataID=9671, Title="VÕn Tiên Chi Thü", posX=0, posY=0, Dir=0, BaseAI=3, AIScript=0, ScriptID=402288 },	["WuLaoDa_BOSS"]			= { DataID=9663, Title="VÕn Tiên Chi Thü", posX=117, posY=49, Dir=11, BaseAI=27, AIScript=0, ScriptID=402279 },	["ZhuoBuFan_BOSS"]		= { DataID=9664, Title="Kiªm Th¥n", posX=121, posY=31, Dir=0, BaseAI=27, AIScript=0, ScriptID=402280 },	["BuPingDaoRen_BOSS"]	= { DataID=9665, Title="Giao Vß½ng", posX=129, posY=31, Dir=0, BaseAI=27, AIScript=261, ScriptID=402281 },	["DuanMuYuan_BOSS"]		= { DataID=9667, Title="", posX=125, posY=36, Dir=0, BaseAI=0, AIScript=0, ScriptID=402287 },	["FuMinYi_NPC"]				= { DataID=9672, Title="", posX=159, posY=54, Dir=11, BaseAI=3, AIScript=0, ScriptID=402286 },	["LiQiuShui_BOSS"]		= { DataID=9666, Title="Th¥n Bí Næ TØ", posX=125, posY=36, Dir=11, BaseAI=27, AIScript=0, ScriptID=402282 },}x402276_g_FightBOSSList ={	[1] = x402276_g_BOSSList["HaDaBa_BOSS"].DataID,	[2] = x402276_g_BOSSList["SangTuGong_BOSS"].DataID,	[3] = x402276_g_BOSSList["WuLaoDa_BOSS"].DataID,	[4] = x402276_g_BOSSList["ZhuoBuFan_BOSS"].DataID,	[5] = x402276_g_BOSSList["BuPingDaoRen_BOSS"].DataID,	[6] = x402276_g_BOSSList["LiQiuShui_BOSS"].DataID}--Whether it is possible to challenge a certain BOSS mark list....x402276_g_BattleFlagTbl = {	["HaDaBa"]			= 8,	--Can you challenge Ha Daba...	["SangTuGong"]	= 9,	--Whether you can challenge Lord Sangtu....	["WuLaoDa"]			= 10,	--Can you challenge Boss Wu....	["ShuangZi"]		= 11,	--Can you challenge Gemini....	["LiQiuShui"]		= 12,	--Can I challenge Li Qiushui....}--Scene variable index....Can you challenge a certain BOSS's mark....-- 0=cannot challenge 1=can challenge 2=already challengedx402276_g_IDX_BattleFlag_Hadaba			= 8x402276_g_IDX_BattleFlag_Sangtugong	= 9x402276_g_IDX_BattleFlag_Wulaoda		= 10x402276_g_IDX_BattleFlag_Shuangzi		= 11x402276_g_IDX_BattleFlag_Liqiushui	= 12x402276_g_IDX_FuBenOpenTime		= 13	--The time when the copy was created....x402276_g_IDX_FuBenLifeStep		= 14	--The step of the dungeon life cycle....(Including the establishment of NPC....Close the countdown prompt....)--Scene variable index....Universal Misty Peak timer....Mainly used to activate BOSS battles....x402276_g_IDX_PMFTimerStep			= 15x402276_g_IDX_PMFTimerScriptID	= 16--Scene variable index...the timer for the death of the black boss...used to handle the death logic....x402276_g_IDX_WuLaoDaDieStep				= 17x402276_g_IDX_WuLaoDaDieScriptID		= 18x402276_g_IDX_WuLaoDaDiePosX				=	19x402276_g_IDX_WuLaoDaDiePosY				=	20--**********************************--Task entry function....--**********************************function x402276_OnDefaultEvent( sceneId, selfId, targetId )	-- Check if you can enter the copy....	local ret, msg = x402276_CheckCanEnter( sceneId, selfId, targetId )	if 1 ~= ret then		BeginEvent(sceneId)			AddText(sceneId,msg)		EndEvent(sceneId)		DispatchEventList(sceneId,selfId,targetId)		return	end	--Close the NPC dialogue window....	BeginUICommand(sceneId)	EndUICommand(sceneId)	DispatchUICommand(sceneId,selfId, 1000)	x402276_MakeCopyScene( sceneId, selfId )end--**********************************-- list events--**********************************function x402276_OnEnumerate( sceneId, selfId, targetId )	AddNumText( sceneId, x402276_g_ScriptId, "S½ chiªn Phiêu Mi¬u Phong", 10, 1 )end--**********************************-- Check if this copy can be entered....--**********************************function x402276_CheckCanEnter( sceneId, selfId, targetId )	--Is there a team....	if LuaFnHasTeam(sceneId,selfId) ~= 1 then		return 0, "#{PMF_20080521_02}"	end	--Is it the captain...	if GetTeamLeader(sceneId,selfId) ~= selfId then		return 0, "#{PMF_20080521_03}"	end	--Is the number of people enough....	if GetTeamSize(sceneId,selfId) < 3 then		return 0, "#{PMF_20080521_04}"	end	-- Are they all nearby....	local NearTeamSize = GetNearTeamCount(sceneId,selfId)	if GetTeamSize(sceneId,selfId) ~= NearTeamSize then		return 0, "#{PMF_20080521_05}"	end	local Humanlist = {}	local nHumanNum = 0	--Is there anyone who is not level 75....	for i=0, NearTeamSize-1 do		local PlayerId = GetNearTeamMember( sceneId, selfId, i )		if GetLevel( sceneId, PlayerId ) < 70 then			Humanlist[nHumanNum] = GetName( sceneId, PlayerId )			nHumanNum = nHumanNum + 1		end	end	if nHumanNum > 0 then		local msg = "    Ðµi ngû · trong"		for i=0, nHumanNum-2 do			msg = msg .. Humanlist[i] .. ""		end		msg = msg .. Humanlist[nHumanNum-1] .. "ÐÆng c¤p còn th¤p, hay là không nên ði thì t¯t h½n."		return 0, msg	end	-- Has anyone done it once today....	nHumanNum = 0	local CurDayTime = GetDayTime()	for i=0, NearTeamSize-1 do		local PlayerId = GetNearTeamMember( sceneId, selfId, i )		local lastTime = GetMissionData( sceneId, PlayerId, MD_PIAOMIAOFENG_SMALL_LASTTIME )		local lastDayTime = floor( lastTime / 100 )		local lastDayCount = mod( lastTime, 100 )			if CurDayTime > lastDayTime then			lastDayTime = CurDayTime			lastDayCount = 0		end		if lastDayCount >= 10 then			Humanlist[nHumanNum] = GetName( sceneId, PlayerId )			nHumanNum = nHumanNum + 1		end	end	if nHumanNum > 0 then		local msg = "    "		for i=0, nHumanNum-2 do			msg = msg .. Humanlist[i] .. ""		end		msg = msg .. Humanlist[nHumanNum-1] .. "V¯n ngày ðã khiêu chiªn qua 10 l¥n Phiêu Mi¬u Phong."		return 0, msg	end	return 1end--**********************************--Create a copy....--**********************************function x402276_MakeCopyScene( sceneId, selfId )	local x = 0	local z = 0	x,z = LuaFnGetWorldPos(sceneId,selfId)	leaderguid=LuaFnObjId2Guid(sceneId,selfId)	LuaFnSetSceneLoad_Map(sceneId, "piaomiao.nav")	LuaFnSetCopySceneData_TeamLeader(sceneId, leaderguid)	LuaFnSetCopySceneData_NoUserCloseTime(sceneId, x402276_g_NoUserTime*1000)	LuaFnSetCopySceneData_Timer(sceneId, x402276_g_TickTime*1000)	LuaFnSetCopySceneData_Param(sceneId, 0, x402276_g_CopySceneType)	LuaFnSetCopySceneData_Param(sceneId, 1, x402276_g_ScriptId)	LuaFnSetCopySceneData_Param(sceneId, 2, 0)	LuaFnSetCopySceneData_Param(sceneId, 3, sceneId)	LuaFnSetCopySceneData_Param(sceneId, 4, x)	LuaFnSetCopySceneData_Param(sceneId, 5, z)	LuaFnSetCopySceneData_Param(sceneId, 6, GetTeamId(sceneId,selfId))	LuaFnSetCopySceneData_Param(sceneId, 7, 0)	for i=8, 31 do		LuaFnSetCopySceneData_Param(sceneId, i, 0)	end	LuaFnSetCopySceneData_Param( sceneId, x402276_g_IDX_BattleFlag_Hadaba, 1 )	LuaFnSetCopySceneData_Param( sceneId, x402276_g_IDX_BattleFlag_Sangtugong, 0 )	LuaFnSetCopySceneData_Param( sceneId, x402276_g_IDX_BattleFlag_Wulaoda, 0 )	LuaFnSetCopySceneData_Param( sceneId, x402276_g_IDX_BattleFlag_Shuangzi, 0 )	LuaFnSetCopySceneData_Param( sceneId, x402276_g_IDX_BattleFlag_Liqiushui, 0 )	LuaFnSetCopySceneData_Param( sceneId, x402276_g_IDX_FuBenOpenTime, LuaFnGetCurrentTime() )	LuaFnSetCopySceneData_Param( sceneId, x402276_g_IDX_FuBenLifeStep, 0 )	LuaFnSetCopySceneData_Param( sceneId, x402276_g_IDX_PMFTimerStep, 0 )	LuaFnSetCopySceneData_Param( sceneId, x402276_g_IDX_PMFTimerScriptID, -1 )	LuaFnSetCopySceneData_Param( sceneId, x402276_g_IDX_WuLaoDaDieStep, 0 )	LuaFnSetCopySceneData_Param( sceneId, x402276_g_IDX_WuLaoDaDieScriptID, -1 )	LuaFnSetCopySceneData_Param( sceneId, x402276_g_IDX_WuLaoDaDiePosX, 0 )	LuaFnSetCopySceneData_Param( sceneId, x402276_g_IDX_WuLaoDaDiePosY, 0 )	LuaFnSetSceneLoad_Area( sceneId, "piaomiao_area.ini" )	LuaFnSetSceneLoad_Monster( sceneId, "piaomiao_monster.ini" )	local bRetSceneID = LuaFnCreateCopyScene(sceneId)	BeginEvent(sceneId)		if bRetSceneID>0 then			AddText(sceneId,"Phó bän tÕo thành công");		else			AddText(sceneId,"S¯ lßþng phó bän ðã ðÕt hÕn mÑc cao nh¤t, xin ch¶ mµt chút thØ lÕi");		end	EndEvent(sceneId)	DispatchMissionTips(sceneId,selfId)end--**********************************-- copy event....--**********************************function x402276_OnCopySceneReady( sceneId, destsceneId )	--Rules for accessing the copy	-- 1.If the player does not form a team, send the player to enter the instance	-- 2, If the player has a team, but the player is not the captain, teleport himself into the instance	-- 3.If the player has a team, and the player is the captain, send himself in with nearby teammates	LuaFnSetCopySceneData_Param(destsceneId, 3, sceneId) --Set the copy entry scene number	leaderguid  = LuaFnGetCopySceneData_TeamLeader(destsceneId)	leaderObjId = LuaFnGuid2ObjId(sceneId,leaderguid)	if LuaFnIsCanDoScriptLogic( sceneId, leaderObjId ) ~= 1 then		return	end	-- Count the number of copies created....	AuditPMFCreateFuben( sceneId, leaderObjId )	if LuaFnHasTeam( sceneId, leaderObjId ) == 0  then		NewWorld( sceneId, leaderObjId, destsceneId, x402276_g_Fuben_X, x402276_g_Fuben_Z) ;	else		if IsCaptain(sceneId, leaderObjId) == 0  then			NewWorld( sceneId, leaderObjId, destsceneId, x402276_g_Fuben_X, x402276_g_Fuben_Z) ;		else			local	nearteammembercount = GetNearTeamCount( sceneId, leaderObjId) 			local mems = {}			for	i=0,nearteammembercount-1 do				mems[i] = GetNearTeamMember(sceneId, leaderObjId, i)				NewWorld( sceneId, mems[i], destsceneId, x402276_g_Fuben_X, x402276_g_Fuben_Z)			end		end			endend--**********************************--Copy scene timer event....--**********************************function x402276_OnCopySceneTimer( sceneId, nowTime )	x402276_TickFubenLife( sceneId, nowTime )	x402276_TickPMFTimer( sceneId, nowTime )	x402276_TickWuLaoDaDieTimer( sceneId, nowTime )	x402276_TickJianWuArea( sceneId, nowTime )end--**********************************--A player enters the dungeon event....--**********************************function x402276_OnPlayerEnter( sceneId, selfId )	-- Set the death event....	SetPlayerDefaultReliveInfo( sceneId, selfId, "%10", -1, "0", sceneId, x402276_g_Fuben_X, x402276_g_Fuben_Z )	--Set to challenge Misty Peak once....	local lastTime = GetMissionData( sceneId, selfId, MD_PIAOMIAOFENG_SMALL_LASTTIME )	local lastDayTime = floor( lastTime / 100 )	local lastDayCount = mod( lastTime, 100 )	local CurDayTime = GetDayTime()	if CurDayTime > lastDayTime then		lastDayTime = CurDayTime		lastDayCount = 0	end	lastDayCount = lastDayCount + 1	lastTime = lastDayTime * 100 + lastDayCount	SetMissionData( sceneId, selfId, MD_PIAOMIAOFENG_SMALL_LASTTIME, lastTime )end--**********************************--A player died in the dungeon....--**********************************function x402276_OnHumanDie( sceneId, selfId, killerId )	end--**********************************--Prompt all players in the instance....--**********************************function x402276_TipAllHuman( sceneId, Str )	local nHumanNum = LuaFnGetCopyScene_HumanCount(sceneId)	for i=0, nHumanNum-1  do		local PlayerId = LuaFnGetCopyScene_HumanObjId(sceneId, i)		if LuaFnIsObjValid( sceneId, PlayerId ) == 1 and LuaFnIsCanDoScriptLogic( sceneId, PlayerId ) == 1 then			BeginEvent(sceneId)				AddText(sceneId, Str)			EndEvent(sceneId)			DispatchMissionTips(sceneId, PlayerId)		end	endend--**********************************--Tick copy lifetime....--**********************************function x402276_TickFubenLife( sceneId, nowTime )	local openTime = LuaFnGetCopySceneData_Param( sceneId, x402276_g_IDX_FuBenOpenTime )	local leftTime = openTime + x402276_g_FuBenTime - LuaFnGetCurrentTime()	local lifeStep = LuaFnGetCopySceneData_Param( sceneId, x402276_g_IDX_FuBenLifeStep )	if lifeStep == 15 then		LuaFnSetCopySceneData_Param( sceneId, x402276_g_IDX_FuBenLifeStep, 16 )		local nHumanNum = LuaFnGetCopyScene_HumanCount(sceneId)		local oldSceneId = LuaFnGetCopySceneData_Param( sceneId, 3 )		local oldX = LuaFnGetCopySceneData_Param( sceneId, 4 )		local oldZ = LuaFnGetCopySceneData_Param( sceneId, 5 )		for i=0, nHumanNum-1  do			local PlayerId = LuaFnGetCopyScene_HumanObjId(sceneId, i)			if LuaFnIsObjValid( sceneId, PlayerId ) == 1 and LuaFnIsCanDoScriptLogic( sceneId, PlayerId ) == 1 then				NewWorld( sceneId, PlayerId, oldSceneId, oldX, oldZ )			end		end		return	end	if lifeStep == 14 then		LuaFnSetCopySceneData_Param( sceneId, x402276_g_IDX_FuBenLifeStep, 15 )		x402276_TipAllHuman( sceneId, "Phó bän t°n tÕi 1 giây sau ðóng lÕi." )		return	end	if lifeStep == 13 then		LuaFnSetCopySceneData_Param( sceneId, x402276_g_IDX_FuBenLifeStep, 14 )		x402276_TipAllHuman( sceneId, "Phó bän t°n tÕi 2 giây sau ðóng lÕi." )		return	end	if lifeStep == 12 then		LuaFnSetCopySceneData_Param( sceneId, x402276_g_IDX_FuBenLifeStep, 13 )		x402276_TipAllHuman( sceneId, "Phó bän t°n tÕi 3 giây sau ðóng lÕi." )		return	end	if lifeStep == 11 then		LuaFnSetCopySceneData_Param( sceneId, x402276_g_IDX_FuBenLifeStep, 12 )		x402276_TipAllHuman( sceneId, "Phó bän t°n tÕi 4 giây sau ðóng lÕi." )		return	end	if lifeStep == 10 then		LuaFnSetCopySceneData_Param( sceneId, x402276_g_IDX_FuBenLifeStep, 11 )		x402276_TipAllHuman( sceneId, "Phó bän t°n tÕi 5 giây sau ðóng lÕi." )		return	end	if leftTime <= 10 and lifeStep == 9 then		LuaFnSetCopySceneData_Param( sceneId, x402276_g_IDX_FuBenLifeStep, 10 )		x402276_TipAllHuman( sceneId, "Phó bän t°n tÕi 10 giây sau ðóng lÕi." )		return	end	if leftTime <= 30 and lifeStep == 8 then		LuaFnSetCopySceneData_Param( sceneId, x402276_g_IDX_FuBenLifeStep, 9 )		x402276_TipAllHuman( sceneId, "Phó bän t°n tÕi 30 giây sau ðóng lÕi." )		return	end	if leftTime <= 60 and lifeStep == 7 then		LuaFnSetCopySceneData_Param( sceneId, x402276_g_IDX_FuBenLifeStep, 8 )		x402276_TipAllHuman( sceneId, "Phó bän t°n tÕi 1 phút sau ðóng lÕi." )		return	end	if leftTime <= 120 and lifeStep == 6 then		LuaFnSetCopySceneData_Param( sceneId, x402276_g_IDX_FuBenLifeStep, 7 )		x402276_TipAllHuman( sceneId, "Phó bän t°n tÕi 2 phút sau ðóng lÕi." )		return	end	if leftTime <= 180 and lifeStep == 5 then		LuaFnSetCopySceneData_Param( sceneId, x402276_g_IDX_FuBenLifeStep, 6 )		x402276_TipAllHuman( sceneId, "Phó bän t°n tÕi 3 phút sau ðóng lÕi." )		return	end	if leftTime <= 300 and lifeStep == 4 then		LuaFnSetCopySceneData_Param( sceneId, x402276_g_IDX_FuBenLifeStep, 5 )		x402276_TipAllHuman( sceneId, "Phó bän t°n tÕi 5 phút sau ðóng lÕi." )		return	end	if leftTime <= 900 and lifeStep == 3 then		LuaFnSetCopySceneData_Param( sceneId, x402276_g_IDX_FuBenLifeStep, 4 )		x402276_TipAllHuman( sceneId, "Phó bän t°n tÕi 15 phút sau ðóng lÕi." )		return	end	if leftTime <= 1800 and lifeStep == 2 then		LuaFnSetCopySceneData_Param( sceneId, x402276_g_IDX_FuBenLifeStep, 3 )		x402276_TipAllHuman( sceneId, "Phó bän t°n tÕi 30 phút sau ðóng lÕi." )		return	end	if leftTime <= 3600 and lifeStep == 1 then		LuaFnSetCopySceneData_Param( sceneId, x402276_g_IDX_FuBenLifeStep, 2 )		x402276_TipAllHuman( sceneId, "Phó bän t°n tÕi 60 phút sau ðóng lÕi." )		return	end	--Initialize the NPC in the copy....	if lifeStep == 0 then		local MstId = x402276_CreateBOSS( sceneId, "HaDaBa_NPC", -1, -1 )		SetUnitReputationID( sceneId, MstId, MstId, 0 )		MstId = x402276_CreateBOSS( sceneId, "SangTuGong_NPC", -1, -1 )		SetUnitReputationID( sceneId, MstId, MstId, 0 )		MstId = x402276_CreateBOSS( sceneId, "WuLaoDa_NPC", -1, -1 )		SetUnitReputationID( sceneId, MstId, MstId, 0 )		MstId = x402276_CreateBOSS( sceneId, "FuMinYi_NPC", -1, -1 )		SetUnitReputationID( sceneId, MstId, MstId, 0 )		LuaFnSetCopySceneData_Param( sceneId, x402276_g_IDX_FuBenLifeStep, 1 )		return	endend--**********************************--Tick Misty Peak timer....--**********************************function x402276_TickPMFTimer( sceneId, nowTime )	local step = LuaFnGetCopySceneData_Param( sceneId, x402276_g_IDX_PMFTimerStep )	if step <= 0 then		return	end	local scriptID = LuaFnGetCopySceneData_Param( sceneId, x402276_g_IDX_PMFTimerScriptID )	--Callback the OnTimer of the specified script....	CallScriptFunction( scriptID, "OnPMFTimer", sceneId, step )	--Turn off the timer if all steps have been walked....	step = step - 1	if step <= 0 then		LuaFnSetCopySceneData_Param( sceneId, x402276_g_IDX_PMFTimerStep, 0 )		LuaFnSetCopySceneData_Param( sceneId, x402276_g_IDX_PMFTimerScriptID, -1 )	else		LuaFnSetCopySceneData_Param( sceneId, x402276_g_IDX_PMFTimerStep, step )	endend--**********************************--Start the Misty Peak timer....--**********************************function x402276_OpenPMFTimer( sceneId, allstep, ScriptID )	LuaFnSetCopySceneData_Param( sceneId, x402276_g_IDX_PMFTimerStep, allstep )	LuaFnSetCopySceneData_Param( sceneId, x402276_g_IDX_PMFTimerScriptID, ScriptID )end--**********************************--Whether the current Misty Peak timer is active....--**********************************function x402276_IsPMFTimerRunning( sceneId )	local step = LuaFnGetCopySceneData_Param( sceneId, x402276_g_IDX_PMFTimerStep )	if step > 0 then		return 1	else		return 0	endend--**********************************--Tick black boss death timer....--**********************************function x402276_TickWuLaoDaDieTimer( sceneId, nowTime )	local step = LuaFnGetCopySceneData_Param( sceneId, x402276_g_IDX_WuLaoDaDieStep )	if step <= 0 then		return	end	local scriptID = LuaFnGetCopySceneData_Param( sceneId, x402276_g_IDX_WuLaoDaDieScriptID )	local posX = LuaFnGetCopySceneData_Param( sceneId, x402276_g_IDX_WuLaoDaDiePosX )	local posY = LuaFnGetCopySceneData_Param( sceneId, x402276_g_IDX_WuLaoDaDiePosY )	--Callback the OnTimer of the specified script....	CallScriptFunction( scriptID, "OnHaDaBaDieTimer", sceneId, step, posX, posY )	--Turn off the timer if all steps have been walked....	step = step - 1	if step <= 0 then		LuaFnSetCopySceneData_Param( sceneId, x402276_g_IDX_WuLaoDaDieStep, 0 )		LuaFnSetCopySceneData_Param( sceneId, x402276_g_IDX_WuLaoDaDieScriptID, -1 )		LuaFnSetCopySceneData_Param( sceneId, x402276_g_IDX_WuLaoDaDiePosX, 0 )		LuaFnSetCopySceneData_Param( sceneId, x402276_g_IDX_WuLaoDaDiePosY, 0 )	else		LuaFnSetCopySceneData_Param( sceneId, x402276_g_IDX_WuLaoDaDieStep, step )	endend--**********************************--Start the black boss death timer....--**********************************function x402276_OpenWuLaoDaDieTimer( sceneId, allstep, ScriptID, posX, posY )	LuaFnSetCopySceneData_Param( sceneId, x402276_g_IDX_WuLaoDaDieStep, allstep )	LuaFnSetCopySceneData_Param( sceneId, x402276_g_IDX_WuLaoDaDieScriptID, ScriptID )	LuaFnSetCopySceneData_Param( sceneId, x402276_g_IDX_WuLaoDaDiePosX, posX )	LuaFnSetCopySceneData_Param( sceneId, x402276_g_IDX_WuLaoDaDiePosY, posY )end--**********************************--Tick sword dance area....--As long as the player stands within the 6 beams of light in the scene...you can get a buff that is immune to the sword dance every second...--**********************************function x402276_TickJianWuArea( sceneId, nowTime )	local nHumanCount = LuaFnGetCopyScene_HumanCount(sceneId)	for i=0, nHumanCount-1 do		local nHumanId = LuaFnGetCopyScene_HumanObjId(sceneId, i)		if LuaFnIsObjValid(sceneId, nHumanId) == 1 and LuaFnIsCanDoScriptLogic(sceneId, nHumanId) == 1 and LuaFnIsCharacterLiving(sceneId, nHumanId) == 1 then			local x,z = GetWorldPos( sceneId, nHumanId )			local buff1 = -1			local buff2 = 10376			if x>=112 and x<=116 and z>=27 and z<=31 then				buff1 = 10370			elseif x>=134 and x<=138 and z>=27 and z<=31 then				buff1 = 10374			elseif x>=145 and x<=149 and z>=46 and z<=50 then				buff1 = 10375			elseif x>=134 and x<=138 and z>=65 and z<=69 then				buff1 = 10371			elseif x>=112 and x<=116 and z>=65 and z<=69 then				buff1 = 10373			elseif x>=101 and x<=105 and z>=46 and z<=50 then				buff1 = 10372			end			if buff1 ~= -1 then				LuaFnSendSpecificImpactToUnit(sceneId, nHumanId, nHumanId, nHumanId, buff1, 0)				LuaFnSendSpecificImpactToUnit(sceneId, nHumanId, nHumanId, nHumanId, buff2, 0)			end		end	endend--**********************************--Create specified BOSS....--**********************************function x402276_CreateBOSS( sceneId, name, x, y )	local BOSSData = x402276_g_BOSSList[name]	if not BOSSData then		return	end	local posX = 0	local posY = 0	if x ~= -1 and y ~= -1 then		posX = x		posY = y	else		posX = BOSSData.posX		posY = BOSSData.posY	end	local MstId = LuaFnCreateMonster( sceneId, BOSSData.DataID, posX, posY, BOSSData.BaseAI, BOSSData.AIScript, BOSSData.ScriptID )	SetObjDir( sceneId, MstId, BOSSData.Dir )	SetMonsterFightWithNpcFlag( sceneId, MstId, 0 )	if BOSSData.Title ~= "" then		SetCharacterTitle(sceneId, MstId, BOSSData.Title)	end	LuaFnSendSpecificImpactToUnit(sceneId, MstId, MstId, MstId, 152, 0)	--Statistics Create BOSS....	AuditPMFCreateBoss( sceneId, BOSSData.DataID )	return MstIdend--**********************************--Delete the specified BOSS....--**********************************function x402276_DeleteBOSS( sceneId, name )	local BOSSData = x402276_g_BOSSList[name]	if not BOSSData then		return	end	local nMonsterNum = GetMonsterCount(sceneId)	for i=0, nMonsterNum-1 do		local MonsterId = GetMonsterObjID(sceneId,i)		if BOSSData.DataID == GetMonsterDataID( sceneId, MonsterId ) then			--LuaFnDeleteMonster( sceneId, MonsterId )			LuaFnSendSpecificImpactToUnit(sceneId, MonsterId, MonsterId, MonsterId, 152, 0)			SetCharacterDieTime( sceneId, MonsterId, 1000 )		end	endend--**********************************--Look for the specified BOSS....--**********************************function x402276_FindBOSS( sceneId, name )	local BOSSData = x402276_g_BOSSList[name]	if not BOSSData then		return -1	end	local nMonsterNum = GetMonsterCount(sceneId)	for i=0, nMonsterNum-1 do		local MonsterId = GetMonsterObjID(sceneId,i)		if BOSSData.DataID == GetMonsterDataID( sceneId, MonsterId ) then			return MonsterId		end	end	return -1end--**********************************--Check if a BOSS already exists....--**********************************function x402276_CheckHaveBOSS( sceneId )	local BossList = {}	local nBossNum = 0	local nMonsterNum = GetMonsterCount(sceneId)	for i=0, nMonsterNum-1 do		local MonsterId = GetMonsterObjID(sceneId,i)		if LuaFnIsCharacterLiving(sceneId, MonsterId) == 1 then			local DataID = GetMonsterDataID( sceneId, MonsterId )			for j, dataId in x402276_g_FightBOSSList do				if DataID == dataId then					BossList[nBossNum] = GetName( sceneId, MonsterId )					nBossNum = nBossNum + 1				end			end		end	end	if nBossNum > 0 then		local msg = "Ðang cùng"		for i=0, nBossNum-2 do			msg = msg .. BossList[i] .. ""		end		msg = msg .. BossList[nBossNum-1] .. "Chiªn ð¤u bên trong"		return 1, msg	end	return 0, ""end--**********************************-- Get the mark of whether you can challenge a certain BOSS....--**********************************function x402276_GetBossBattleFlag( sceneId, bossName )	local idx = x402276_g_BattleFlagTbl[ bossName ]	return LuaFnGetCopySceneData_Param( sceneId, idx )end--**********************************--Set whether you can challenge a BOSS mark....--**********************************function x402276_SetBossBattleFlag( sceneId, bossName, bCan )	local idx = x402276_g_BattleFlagTbl[ bossName ]	LuaFnSetCopySceneData_Param( sceneId, idx, bCan )end