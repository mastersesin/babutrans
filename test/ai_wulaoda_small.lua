--Piao Miao Peak Wu Boss AI--A Golden Lantern Ten Thousand LightsPoison attribute group attack....--B [Paralyzing Poison] Ordinary skills...in the whole copy, randomly pick a person to release empty skills on it...and then add a buff to it....--C [Green Wave Fragrance] Use an empty skill on yourself...and put a trap at the foot of the current enemy....--D [Toxic transformation] Add a buff to everyone in the whole copy every 5 seconds....--The whole process has buffs that are immune to formulating skills....--After 20 seconds, the ABC skills will be released cyclically....Cool down for 20 seconds....-- Use D...every 5 seconds--Boss death or leaving the battle will clear the buff of D for everyone....--script numberx402279_g_ScriptId	= 402279--Copy logic script number....x402279_g_FuBenScriptId = 402276--Immunity Buff....x402279_Buff_MianYi1	= 10472	-- Immune to some negative effects....x402279_Buff_MianYi2	= 10471	-- Immune to normal invisibility....--ABC skills....x402279_SkillA			= 1111	--The simple version of Misty Peak uses a version with reduced damage....x402279_SkillB			= 1112	--The simple version of Misty Peak uses a version with reduced damage....x402279_BuffB				= 19803	--The simple version of Misty Peak uses a version with reduced damage....x402279_SkillC			= 1113	--The simple version of Misty Peak uses a version with reduced damage....x402279_SpeObjC			= 72	--The simple version of Misty Peak uses a version with reduced damage....x402279_SkillABC_CD	=	20000--D skill....x402279_BuffD				= 19801	--The simple version of Misty Peak uses a version with reduced damage....x402279_SkillD_CD		= 5000--AI Index....x402279_IDX_CD_SkillABC		= 1	--ABC skill CD....x402279_IDX_CurSkillIndex	= 2	--Which skill in ABC should I use next....x402279_IDX_CD_SkillD			= 3	--CD of skill D....x402279_IDX_CombatFlag 		= 1	--Whether it is a sign of combat status....--**********************************--initialization....--**********************************function x402279_OnInit(sceneId, selfId)	--Reset AI....	x402279_ResetMyAI( sceneId, selfId )end--**********************************--heartbeat....--**********************************function x402279_OnHeartBeat(sceneId, selfId, nTick)	-- Check if it is dead....	if LuaFnIsCharacterLiving(sceneId, selfId) ~= 1 then		return	end	-- Check if not in combat state....	if 0 == MonsterAI_GetBoolParamByIndex( sceneId, selfId, x402279_IDX_CombatFlag ) then		return	end	--ABC skill heartbeat....	if 1 == x402279_TickSkillABC( sceneId, selfId, nTick ) then		return	end	--D skill heartbeat....	if 1 == x402279_TickSkillD( sceneId, selfId, nTick ) then		return	endend--**********************************-- enter the battle....--**********************************function x402279_OnEnterCombat(sceneId, selfId, enmeyId)	--Add initial buff....	LuaFnSendSpecificImpactToUnit( sceneId, selfId, selfId, selfId, x402279_Buff_MianYi1, 0 )	LuaFnSendSpecificImpactToUnit( sceneId, selfId, selfId, selfId, x402279_Buff_MianYi2, 0 )	--Reset AI....	x402279_ResetMyAI( sceneId, selfId )	--Set to enter the combat state....	MonsterAI_SetBoolParamByIndex( sceneId, selfId, x402279_IDX_CombatFlag, 1 )end--**********************************--leave the fight....--**********************************function x402279_OnLeaveCombat(sceneId, selfId)	--Reset AI....	x402279_ResetMyAI( sceneId, selfId )	--delete self....	LuaFnDeleteMonster( sceneId, selfId )	--Create a dialogue NPC....	local MstId = CallScriptFunction( x402279_g_FuBenScriptId, "CreateBOSS", sceneId, "WuLaoDa_NPC", -1, -1 )	SetUnitReputationID( sceneId, MstId, MstId, 0 )end--**********************************-- kill enemies....--**********************************function x402279_OnKillCharacter(sceneId, selfId, targetId)end--**********************************--die....--**********************************function x402279_OnDie( sceneId, selfId, killerId )	--Reset AI....	x402279_ResetMyAI( sceneId, selfId )	--delete self....	SetCharacterDieTime( sceneId, selfId, 3000 )	--Start the timer for the death of Boss Wu....	local x,z = GetWorldPos( sceneId, selfId )	CallScriptFunction( x402279_g_FuBenScriptId, "OpenWuLaoDaDieTimer", sceneId, 4, x402279_g_ScriptId, x, z )	--The setting has already challenged Wu Boss....	CallScriptFunction( x402279_g_FuBenScriptId, "SetBossBattleFlag", sceneId, "WuLaoDa", 2 )	--If you have not challenged Gemini, you can challenge Gemini....	if 2 ~= CallScriptFunction( x402279_g_FuBenScriptId, "GetBossBattleFlag", sceneId, "ShuangZi" )	then		CallScriptFunction( x402279_g_FuBenScriptId, "SetBossBattleFlag", sceneId, "ShuangZi", 1 )	end	-- zchw global announcement	local	playerName	= GetName( sceneId, killerId )		--The one who kills the monster is a pet, then get the name of its owner....	local playerID = killerId	local objType = GetCharacterType( sceneId, killerId )	if objType == 3 then		playerID = GetPetCreator( sceneId, killerId )		playerName = GetName( sceneId, playerID )	end		--If the player is in a team, get the captain's name....	local leaderID = GetTeamLeader( sceneId, playerID )	if leaderID ~= -1 then		playerName = GetName( sceneId, leaderID )	end		if playerName ~= nil then		str = format("#{_INFOUSR%s}#{XPM_8724_4}", playerName);      -- Boss Wu		AddGlobalCountNews( sceneId, str )	endend--**********************************--Reset AI....--**********************************function x402279_ResetMyAI( sceneId, selfId )	--reset parameters....	MonsterAI_SetIntParamByIndex( sceneId, selfId, x402279_IDX_CD_SkillABC, x402279_SkillABC_CD )	MonsterAI_SetIntParamByIndex( sceneId, selfId, x402279_IDX_CurSkillIndex, 1 )	MonsterAI_SetIntParamByIndex( sceneId, selfId, x402279_IDX_CD_SkillD, x402279_SkillD_CD )	MonsterAI_SetBoolParamByIndex( sceneId, selfId, x402279_IDX_CombatFlag, 0 )	--Clear the buff of D for everyone....	local nHumanCount = LuaFnGetCopyScene_HumanCount(sceneId)	for i=0, nHumanCount-1 do		local nHumanId = LuaFnGetCopyScene_HumanObjId(sceneId, i)		if LuaFnIsObjValid(sceneId, nHumanId) == 1 and LuaFnIsCanDoScriptLogic(sceneId, nHumanId) == 1 then			LuaFnCancelSpecificImpact( sceneId, nHumanId, x402279_BuffD )		end	endend--**********************************--ABC skill heartbeat....--**********************************function x402279_TickSkillABC( sceneId, selfId, nTick )	--Update skill CD....	local cd = MonsterAI_GetIntParamByIndex( sceneId, selfId, x402279_IDX_CD_SkillABC )	if cd > nTick then		MonsterAI_SetIntParamByIndex( sceneId, selfId, x402279_IDX_CD_SkillABC, cd-nTick )		return 0	else		MonsterAI_SetIntParamByIndex( sceneId, selfId, x402279_IDX_CD_SkillABC, x402279_SkillABC_CD-(nTick-cd) )		local CurSkill = MonsterAI_GetIntParamByIndex( sceneId, selfId, x402279_IDX_CurSkillIndex )		if CurSkill == 1 then			MonsterAI_SetIntParamByIndex( sceneId, selfId, x402279_IDX_CurSkillIndex, 2 )			return x402279_UseSkillA( sceneId, selfId )		elseif CurSkill == 2 then			MonsterAI_SetIntParamByIndex( sceneId, selfId, x402279_IDX_CurSkillIndex, 3 )			return x402279_UseSkillB( sceneId, selfId )		elseif CurSkill == 3 then			MonsterAI_SetIntParamByIndex( sceneId, selfId, x402279_IDX_CurSkillIndex, 1 )			return x402279_UseSkillC( sceneId, selfId )		end	endend--**********************************--D skill heartbeat....--**********************************function x402279_TickSkillD( sceneId, selfId, nTick )	--Update skill CD....	local cd = MonsterAI_GetIntParamByIndex( sceneId, selfId, x402279_IDX_CD_SkillD )	if cd > nTick then		MonsterAI_SetIntParamByIndex( sceneId, selfId, x402279_IDX_CD_SkillD, cd-nTick )		return 0	else		MonsterAI_SetIntParamByIndex( sceneId, selfId, x402279_IDX_CD_SkillD, x402279_SkillD_CD-(nTick-cd) )		return x402279_UseSkillD( sceneId, selfId )	endend--**********************************-- Use A skill....--**********************************function x402279_UseSkillA( sceneId, selfId )	local x,z = GetWorldPos( sceneId, selfId )	LuaFnUnitUseSkill( sceneId, selfId, x402279_SkillA, selfId, x, z, 0, 1 )	return 1end--**********************************-- Use B skill....--**********************************function x402279_UseSkillB( sceneId, selfId )	-- List of active players in the instance....	local PlayerList = {}	-- Add valid people to the list....	local numPlayer = 0	local nHumanCount = LuaFnGetCopyScene_HumanCount(sceneId)	for i=0, nHumanCount-1 do		local nHumanId = LuaFnGetCopyScene_HumanObjId(sceneId, i)		if LuaFnIsObjValid(sceneId, nHumanId) == 1 and LuaFnIsCanDoScriptLogic(sceneId, nHumanId) == 1 and LuaFnIsCharacterLiving(sceneId, nHumanId) == 1 then			PlayerList[numPlayer+1] = nHumanId			numPlayer = numPlayer + 1		end	end	-- Randomly pick a player....	if numPlayer <= 0 then		return 0	end	local PlayerId = PlayerList[ random(numPlayer) ]	-- Use skills on it....	local x,z = GetWorldPos( sceneId, PlayerId )	LuaFnUnitUseSkill( sceneId, selfId, x402279_SkillB, PlayerId, x, z, 0, 1 )	--Add buff to it....	LuaFnSendSpecificImpactToUnit( sceneId, selfId, selfId, PlayerId, x402279_BuffB, 0 )	return 1end--**********************************-- Use C skills....--**********************************function x402279_UseSkillC( sceneId, selfId )	-- get the current enemy....	local enemyId = GetMonsterCurEnemy( sceneId, selfId )	if enemyId <= 0 then		return 0	end	if GetCharacterType( sceneId, enemyId ) == 3 then		enemyId = GetPetCreator( sceneId, enemyId )	end	--Put a trap under the enemy's feet....	local x,z = GetWorldPos( sceneId, enemyId )	CreateSpecialObjByDataIndex( sceneId, selfId, x402279_SpeObjC, x, z, 0 )	-- Shout out....	MonsterTalk( sceneId, -1, "", "#{PMF_20080530_17}" )	-- Use an empty skill with only special effects on yourself....	x,z = GetWorldPos( sceneId, selfId )	LuaFnUnitUseSkill( sceneId, selfId, x402279_SkillC, selfId, x, z, 0, 1 )	return 1end--**********************************-- Use D skills....--**********************************function x402279_UseSkillD( sceneId, selfId )	--Add buff to everyone in the copy....	local nHumanCount = LuaFnGetCopyScene_HumanCount(sceneId)	for i=0, nHumanCount-1 do		local nHumanId = LuaFnGetCopyScene_HumanObjId(sceneId, i)		if LuaFnIsObjValid(sceneId, nHumanId) == 1 and LuaFnIsCanDoScriptLogic(sceneId, nHumanId) == 1 and LuaFnIsCharacterLiving(sceneId, nHumanId) == 1 then			LuaFnSendSpecificImpactToUnit( sceneId, selfId, selfId, nHumanId, x402279_BuffD, 0 )		end	endend--**********************************-- OnTimer, the black boss death timer....--Used to control the delay in spawning the defeated Wu Boss after death....--**********************************function x402279_OnHaDaBaDieTimer( sceneId, step, posX, posY )	if 1 == step then		--Create the defeated Wu Boss NPC....		local MstId = CallScriptFunction( x402279_g_FuBenScriptId, "CreateBOSS", sceneId, "WuLaoDaLoss_NPC", posX, posY )		SetUnitReputationID( sceneId, MstId, MstId, 0 )		SetPatrolId(sceneId, MstId, 0)	endend