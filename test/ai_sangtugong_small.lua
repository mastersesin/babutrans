--Piaomiao Peak Sangtugong AI--A Earth DungeonBoss will disappear for 20 seconds every time 20% of its HP is lost.At the same time, 1122 mobs will be created at the same time.They will disappear after dying or leaving the battle....--B [Ox Hair Poisonous Needle] A large-scale attack every 20 times when not in the state of earth escape...CD is normal in the state of earth escape, but it is not used....CD is cleared at the end of earth escape....--C [Unearthed cultural relics] Randomly get 2 buffs when entering the earth dungeon...and clear the last 2 buffs at the same time....--D [Crazy] Add a fatal buff to yourself and all zombies after fighting for 5 minutes...no longer use AB(C)....--The whole process has buffs that are immune to formulating skills....--Delete zombies when out of combat or on death....--script numberx402278_g_ScriptId	= 402278--Copy logic script number....x402278_g_FuBenScriptId = 402276--Immune to specific skill buff....x402278_Buff_MianYi1	= 10472	-- Immune to some negative effects....x402278_Buff_MianYi2	= 10471	-- Immune to normal invisibility....--A Tudun....x402278_SkillA_TuDun				= 1028x402278_SkillA_ChildName		= "Bích Lân Cß½ng Thi"x402278_SkillA_ChildBuff		= 10246x402278_SkillA_ChildTime		= 5000		--How long does it take for the earth to escape and start spawning mobs....x402278_SkillA_Time					= 20000		--The duration of earth escape....--B Bull Hair Poisonous Needle....x402278_SkillB_NiuMaoDuZhen = 1110	--The simple version of Misty Peak uses a version with reduced damage....--Cooldown time....x402278_SkillB_CD						= 20000--C buff list of unearthed cultural relic skills....x402278_SkillC_ChutuBuff1 = { 10237, 10238 }x402278_SkillC_ChutuBuff2 = { 10239, 10240, 10241, 10242 }--D Crazy....x402278_SkillD_Buff1	= 10234x402278_SkillD_Buff2	= 10235--Time to start going berserk....x402278_EnterKuangBaoTime	= 5*60*1000--AI Index....x402278_IDX_HPStep							= 1	--Health level....x402278_IDX_SkillB_CD						= 2	--CD time of skill B....x402278_IDX_KuangBaoTimer				= 3	--Rampage Timer....x402278_IDX_TuDunTimer					= 4	--The timer of Tudun...is used to calculate when the Tudun ends....x402278_IDX_NeedCreateChildNum	= 5	--Number of mobs to create....x402278_IDX_CombatFlag 			= 1	--Whether it is a sign of combat status....x402278_IDX_IsTudunMode			= 2	--A sign of whether it is in Tudun mode....x402278_IDX_IsKuangBaoMode	= 3	-- flag for berserk mode....--**********************************--initialization....--**********************************function x402278_OnInit(sceneId, selfId)	--Reset AI....	x402278_ResetMyAI( sceneId, selfId )end--**********************************--heartbeat....--**********************************function x402278_OnHeartBeat(sceneId, selfId, nTick)	-- Check if it is dead....	if LuaFnIsCharacterLiving(sceneId, selfId) ~= 1 then		return	end	-- Check if not in combat state....	if 0 == MonsterAI_GetBoolParamByIndex( sceneId, selfId, x402278_IDX_CombatFlag ) then		return	end	--Rage state does not need logic....	if 1 == MonsterAI_GetBoolParamByIndex( sceneId, selfId, x402278_IDX_IsKuangBaoMode ) then		return	end	--Execute rampage logic....	if 1 == x402278_DoSkillD_KuangBao( sceneId, selfId, nTick ) then		return	end	--Execute the earth escape logic....	if 1 == x402278_SkillLogicA_TunDun( sceneId, selfId, nTick ) then		return	end	--Execute the logic of ox hair and poison needle....	if 1 == x402278_SkillLogicB_NiuMaoDuZhen( sceneId, selfId, nTick ) then		return	endend--**********************************-- enter the battle....--**********************************function x402278_OnEnterCombat(sceneId, selfId, enmeyId)	--Add initial buff....	LuaFnSendSpecificImpactToUnit( sceneId, selfId, selfId, selfId, x402278_Buff_MianYi1, 0 )	LuaFnSendSpecificImpactToUnit( sceneId, selfId, selfId, selfId, x402278_Buff_MianYi2, 0 )	--Reset AI....	x402278_ResetMyAI( sceneId, selfId )	--Set to enter the combat state....	MonsterAI_SetBoolParamByIndex( sceneId, selfId, x402278_IDX_CombatFlag, 1 )end--**********************************--leave the fight....--**********************************function x402278_OnLeaveCombat(sceneId, selfId)	--Reset AI....	x402278_ResetMyAI( sceneId, selfId )	--delete self....	LuaFnDeleteMonster( sceneId, selfId )	--Create a dialogue NPC....	local MstId = CallScriptFunction( x402278_g_FuBenScriptId, "CreateBOSS", sceneId, "SangTuGong_NPC", -1, -1 )	SetUnitReputationID( sceneId, MstId, MstId, 0 )end--**********************************-- kill enemies....--**********************************function x402278_OnKillCharacter(sceneId, selfId, targetId)end--**********************************--die....--**********************************function x402278_OnDie( sceneId, selfId, killerId )	--Reset AI....	x402278_ResetMyAI( sceneId, selfId )	--The setting has already challenged Sangtu Gong....	CallScriptFunction( x402278_g_FuBenScriptId, "SetBossBattleFlag", sceneId, "SangTuGong", 2 )	--If you haven't challenged Boss Wu, you can challenge Boss Wu....	if 2 ~= CallScriptFunction( x402278_g_FuBenScriptId, "GetBossBattleFlag", sceneId, "WuLaoDa" )	then		CallScriptFunction( x402278_g_FuBenScriptId, "SetBossBattleFlag", sceneId, "WuLaoDa", 1 )	end	-- zchw global announcement	local	playerName	= GetName( sceneId, killerId )		--The one who kills the monster is a pet, then get the name of its owner....	local playerID = killerId	local objType = GetCharacterType( sceneId, killerId )	if objType == 3 then		playerID = GetPetCreator( sceneId, killerId )		playerName = GetName( sceneId, playerID )	end		--If the player is in a team, get the captain's name....	local leaderID = GetTeamLeader( sceneId, playerID )	if leaderID ~= -1 then		playerName = GetName( sceneId, leaderID )	end		if playerName ~= nil then		str = format("#{_INFOUSR%s}#{XPM_8724_3}", playerName);             --Sangtu Gong		AddGlobalCountNews( sceneId, str )	endend--**********************************--Reset AI....--**********************************function x402278_ResetMyAI( sceneId, selfId )	--reset parameters....	MonsterAI_SetIntParamByIndex( sceneId, selfId, x402278_IDX_HPStep, 0 )	MonsterAI_SetIntParamByIndex( sceneId, selfId, x402278_IDX_SkillB_CD, x402278_SkillB_CD )	MonsterAI_SetIntParamByIndex( sceneId, selfId, x402278_IDX_KuangBaoTimer, 0 )	MonsterAI_SetIntParamByIndex( sceneId, selfId, x402278_IDX_TuDunTimer, 0 )	MonsterAI_SetIntParamByIndex( sceneId, selfId, x402278_IDX_NeedCreateChildNum, 0 )	MonsterAI_SetBoolParamByIndex( sceneId, selfId, x402278_IDX_CombatFlag, 0 )	MonsterAI_SetBoolParamByIndex( sceneId, selfId, x402278_IDX_IsTudunMode, 0 )	MonsterAI_SetBoolParamByIndex( sceneId, selfId, x402278_IDX_IsKuangBaoMode, 0 )	--clear buff....	for i, buffId in x402278_SkillC_ChutuBuff1 do		LuaFnCancelSpecificImpact( sceneId, selfId, buffId )	end	for i, buffId in x402278_SkillC_ChutuBuff2 do		LuaFnCancelSpecificImpact( sceneId, selfId, buffId )	end	LuaFnCancelSpecificImpact( sceneId, selfId, x402278_SkillD_Buff1 )	LuaFnCancelSpecificImpact( sceneId, selfId, x402278_SkillD_Buff2 )	-- Clear mobs....	local nMonsterNum = GetMonsterCount(sceneId)	for i=0, nMonsterNum-1 do		local MonsterId = GetMonsterObjID(sceneId,i)		if GetName(sceneId, MonsterId) == x402278_SkillA_ChildName then			LuaFnDeleteMonster(sceneId, MonsterId)		end	endend--**********************************--Rage skill....--**********************************function x402278_DoSkillD_KuangBao( sceneId, selfId )	--add berserk buff....	LuaFnSendSpecificImpactToUnit( sceneId, selfId, selfId, selfId, x402278_SkillD_Buff1, 0 )	LuaFnSendSpecificImpactToUnit( sceneId, selfId, selfId, selfId, x402278_SkillD_Buff2, 0 )	--Add rage to all mobs....	local nMonsterNum = GetMonsterCount(sceneId)	for i=0, nMonsterNum-1 do		local MonsterId = GetMonsterObjID(sceneId,i)		if GetName(sceneId, MonsterId) == x402278_SkillA_ChildName then			LuaFnSendSpecificImpactToUnit( sceneId, MonsterId, MonsterId, MonsterId, x402278_SkillD_Buff1, 0 )			LuaFnSendSpecificImpactToUnit( sceneId, MonsterId, MonsterId, MonsterId, x402278_SkillD_Buff2, 0 )		end	endend--**********************************--Earth escape logic....--**********************************function x402278_SkillLogicA_TunDun( sceneId, selfId, nTick )	--The Tudun mode will update the timer of the Tudun....	if 1 == MonsterAI_GetBoolParamByIndex( sceneId, selfId, x402278_IDX_IsTudunMode ) then		local cd = MonsterAI_GetIntParamByIndex( sceneId, selfId, x402278_IDX_TuDunTimer )		if cd > nTick then			MonsterAI_SetIntParamByIndex( sceneId, selfId, x402278_IDX_TuDunTimer, cd-nTick )			--If it's time to spawn mobs and you haven't brushed mobs this time....			if cd < (x402278_SkillA_Time-x402278_SkillA_ChildTime) then				local needCreateNum = MonsterAI_GetIntParamByIndex( sceneId, selfId, x402278_IDX_NeedCreateChildNum )				if needCreateNum > 0 then					-- Create mobs....					MonsterAI_SetIntParamByIndex( sceneId, selfId, x402278_IDX_NeedCreateChildNum, 0 )					local x,z = GetWorldPos( sceneId, selfId )					for i=1, needCreateNum do						local MstId = CallScriptFunction( x402278_g_FuBenScriptId, "CreateBOSS", sceneId, "JiangShi_BOSS", x, z )						LuaFnSendSpecificImpactToUnit( sceneId, MstId, MstId, MstId, x402278_SkillA_ChildBuff, 0 )						SetCharacterName( sceneId, MstId, x402278_SkillA_ChildName )					end				end			end		else			--End of Tudun....Set to leave Tudun status....			MonsterAI_SetIntParamByIndex( sceneId, selfId, x402278_IDX_TuDunTimer, 0 )			MonsterAI_SetBoolParamByIndex( sceneId, selfId, x402278_IDX_IsTudunMode, 0 )			--Reset the Ox Hair Poison Needle CD....			MonsterAI_SetIntParamByIndex( sceneId, selfId, x402278_IDX_SkillB_CD, x402278_SkillB_CD )		end	-- Non-earth escape mode checks whether you can enter the earth escape mode....	else		--Enter the Earth Dungeon mode every time the blood is reduced by 20%....		local CurPercent = GetHp( sceneId, selfId ) / GetMaxHp( sceneId, selfId )		local LastStep = MonsterAI_GetIntParamByIndex( sceneId, selfId, x402278_IDX_HPStep )		local CurStep = -1		if CurPercent <= 0.2 then			CurStep = 4		elseif CurPercent <= 0.4 then		 	CurStep = 3		elseif CurPercent <= 0.6 then		 	CurStep = 2		elseif CurPercent <= 0.8 then			CurStep = 1		end		--Perform earth escape....		if CurStep > LastStep then			--Set yourself invisible and can't attack....			local x,z = GetWorldPos( sceneId, selfId )			LuaFnUnitUseSkill( sceneId, selfId, x402278_SkillA_TuDun, selfId, x, z, 0, 1 )			--Randomly get 2 buffs (unearthed cultural relics)....			local idx1 = random( getn(x402278_SkillC_ChutuBuff1) )			LuaFnSendSpecificImpactToUnit( sceneId, selfId, selfId, selfId, x402278_SkillC_ChutuBuff1[idx1], 0 )			local idx2 = random( getn(x402278_SkillC_ChutuBuff2) )			LuaFnSendSpecificImpactToUnit( sceneId, selfId, selfId, selfId, x402278_SkillC_ChutuBuff2[idx2], 0 )			local NeedCreateNum = 1			if CurStep == 3 or CurStep == 4 then				NeedCreateNum = 2			end			MonsterAI_SetBoolParamByIndex( sceneId, selfId, x402278_IDX_IsTudunMode, 1 )			MonsterAI_SetIntParamByIndex( sceneId, selfId, x402278_IDX_NeedCreateChildNum, NeedCreateNum )			MonsterAI_SetIntParamByIndex( sceneId, selfId, x402278_IDX_HPStep, CurStep )			MonsterAI_SetIntParamByIndex( sceneId, selfId, x402278_IDX_TuDunTimer, x402278_SkillA_Time )			return 1		end	end	return 0end--**********************************--The logic of ox hair and poison needle....--**********************************function x402278_SkillLogicB_NiuMaoDuZhen( sceneId, selfId, nTick )	--Update skill CD....	local cd = MonsterAI_GetIntParamByIndex( sceneId, selfId, x402278_IDX_SkillB_CD )	if cd > nTick then		MonsterAI_SetIntParamByIndex( sceneId, selfId, x402278_IDX_SkillB_CD, cd-nTick )	else		MonsterAI_SetIntParamByIndex( sceneId, selfId, x402278_IDX_SkillB_CD, x402278_SkillB_CD-(nTick-cd) )		--Only available in non-earth escape state....		if 0 == MonsterAI_GetBoolParamByIndex( sceneId, selfId, x402278_IDX_IsTudunMode ) then			local x,z = GetWorldPos( sceneId, selfId )			MonsterTalk( sceneId, -1, "", "#{PMF_20080530_16}" )			LuaFnUnitUseSkill( sceneId, selfId, x402278_SkillB_NiuMaoDuZhen, selfId, x, z, 0, 0 )			return 1		end	end	return 0end--**********************************-- Berserk logic....--**********************************function x402278_DoSkillD_KuangBao( sceneId, selfId, nTick )	-- Check if it's time to go berserk....	local kbTime = MonsterAI_GetIntParamByIndex( sceneId, selfId, x402278_IDX_KuangBaoTimer )	if kbTime < x402278_EnterKuangBaoTime then		MonsterAI_SetIntParamByIndex( sceneId, selfId, x402278_IDX_KuangBaoTimer, kbTime+nTick )	else		MonsterAI_SetBoolParamByIndex( sceneId, selfId, x402278_IDX_IsKuangBaoMode, 1 )		--add berserk buff....		LuaFnSendSpecificImpactToUnit( sceneId, selfId, selfId, selfId, x402278_SkillD_Buff1, 0 )		LuaFnSendSpecificImpactToUnit( sceneId, selfId, selfId, selfId, x402278_SkillD_Buff2, 0 )		--Add rage buff to all mobs....		local nMonsterNum = GetMonsterCount(sceneId)		for i=0, nMonsterNum-1 do			local MonsterId = GetMonsterObjID(sceneId,i)			if GetName(sceneId, MonsterId) == x402278_SkillA_ChildName then				LuaFnSendSpecificImpactToUnit( sceneId, MonsterId, MonsterId, MonsterId, x402278_SkillD_Buff1, 0 )				LuaFnSendSpecificImpactToUnit( sceneId, MonsterId, MonsterId, MonsterId, x402278_SkillD_Buff2, 0 )			end		end		return 1	end	return 0end